name: Backend CI/CD Pipeline

on:
  push:
    branches: [ main, master ]
    tags:
      - 'v*-dev'
      - 'v*-test'

env:
  DOCKER_USERNAME: facundo676
  IMAGE_NAME: backend-shop
  INFRA_REPO: Gitops-Facundoh3/gitops-shop-demo

jobs:
  build-and-publish:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.meta.outputs.version }}
      short_sha: ${{ steps.meta.outputs.short_sha }}
      environment: ${{ steps.environment.outputs.env }}

    steps:
    - name: Checkout backend code
      uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Cache Maven dependencies
      uses: actions/cache@v4
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2

    - name: Run tests
      run: mvn test

    - name: Build application
      run: mvn clean package -DskipTests

    - name: Generate version tags
      id: meta
      run: |
        SHORT_SHA=${GITHUB_SHA::7}
        TIMESTAMP=$(date +%Y%m%d-%H%M%S)
        echo "short_sha=${SHORT_SHA}" >> $GITHUB_OUTPUT
        echo "timestamp=${TIMESTAMP}" >> $GITHUB_OUTPUT
        echo "version=${TIMESTAMP}-${SHORT_SHA}" >> $GITHUB_OUTPUT

    - name: Determine target environment
      id: environment
      run: |
        if [[ "${{ github.ref }}" == refs/tags/* ]]; then
          TAG_NAME=${GITHUB_REF#refs/tags/}
          echo "Tag detectado: $TAG_NAME"
          if [[ "$TAG_NAME" == *-dev ]]; then
            echo "env=dev" >> $GITHUB_OUTPUT
            echo "Ambiente destino: dev"
          elif [[ "$TAG_NAME" == *-test ]]; then
            echo "env=test" >> $GITHUB_OUTPUT
            echo "Ambiente destino: test"
          else
            echo "ERROR: Tag debe terminar en -dev o -test"
            exit 1
          fi
        else
          echo "env=none" >> $GITHUB_OUTPUT
          echo "No es un tag, saltando deployment"
        fi

    - name: Log in to Docker Hub
      if: steps.environment.outputs.env != 'none'
      uses: docker/login-action@v3
      with:
        username: ${{ env.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    - name: Build and push Docker image
      if: steps.environment.outputs.env != 'none'
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfile
        push: true
        tags: |
          ${{ env.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:latest
          ${{ env.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:${{ steps.meta.outputs.version }}
          ${{ env.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:${{ steps.meta.outputs.short_sha }}

  update-infrastructure:
    needs: build-and-publish
    runs-on: ubuntu-latest
    if: needs.build-and-publish.outputs.environment != 'none'

    steps:
    - name: Checkout infrastructure repository
      uses: actions/checkout@v4
      with:
        repository: ${{ env.INFRA_REPO }}
        token: ${{ secrets.INFRA_TOKEN }}
        path: infra

    - name: Determine values file to update
      id: values_file
      run: |
        ENV="${{ needs.build-and-publish.outputs.environment }}"
        VALUES_FILE="helm-charts/backend/values-${ENV}.yaml"
        echo "values_file=${VALUES_FILE}" >> $GITHUB_OUTPUT
        echo "Archivo a actualizar: ${VALUES_FILE}"

    - name: Update image tag in values file
      working-directory: infra
      run: |
        VALUES_FILE="${{ steps.values_file.outputs.values_file }}"
        NEW_TAG="${{ needs.build-and-publish.outputs.version }}"
        echo "Actualizando $VALUES_FILE con tag: $NEW_TAG"
        if [ ! -f "$VALUES_FILE" ]; then
          echo "ERROR: Archivo $VALUES_FILE no existe"
          exit 1
        fi
        sed -i "s|tag: .*|tag: \"$NEW_TAG\"|g" $VALUES_FILE
        echo "Cambios realizados:"
        git diff $VALUES_FILE

    - name: Commit and push changes
      working-directory: infra
      run: |
        ENV="${{ needs.build-and-publish.outputs.environment }}"
        VERSION="${{ needs.build-and-publish.outputs.version }}"
        git config --local user.email "ci-bot@github.com"
        git config --local user.name "CI Bot"
        if git diff --quiet; then
          echo "No hay cambios para commitear"
          exit 0
        fi
        echo "Archivos modificados:"
        git diff --name-only
        git add .
        git commit -m "Update backend ($ENV) to $VERSION"
        git push
        echo "Cambios pusheados exitosamente"
